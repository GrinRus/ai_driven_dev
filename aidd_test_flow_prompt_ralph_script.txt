Задача: AIDD E2E Flow Audit (TST-001) + Ralph Loop Compliance + W91/W92/W93 (Skill-first/DocOps/Preflight) Readiness

Роль: ты — один аудитор-агент. Проведи полный e2e прогон AIDD флоу в одном репозитории и собери доказательства (логи/артефакты). НЕ “чиняй” проект и НЕ делай ручные правки AIDD docs ради прохождения гейтов.

Канон vs runtime:
- Канон templates: $PLUGIN_DIR/templates/aidd/**
- Канон skills: $PLUGIN_DIR/skills/**
- Runtime “память” AIDD: $PROJECT_DIR/aidd/** (после aidd-init)
- Runtime tooling: $PLUGIN_DIR/tools/** и $PLUGIN_DIR/hooks/**

============================================================
ПЕРЕМЕННЫЕ

- PROJECT_DIR=/Users/griogrii_riabov/grigorii_projects/ai_advent_challenge
- PLUGIN_DIR=/Users/griogrii_riabov/grigorii_projects/ai_driven_dev
- CLAUDE_PLUGIN_ROOT=$PLUGIN_DIR

- TICKET=TST-001
- SLUG_HINT=tst-001-demo   # фиксируем slug-hint, чтобы не “загрязнялся” note/answers

- LOOP_MODE=loop-run|loop-step          # default: loop-run
- LOOP_RUNNER=<optional>
- AIDD_HOOKS_MODE=fast|strict           # default: fast (strict только если явно просят)

============================================================
КРИТИЧНО: ПОЛИТИКА ОЖИДАНИЯ (НЕ ОСТАНАВЛИВАТЬ “SILENT RUN”)

В этом аудите “silent stdout” — НОРМА. Нельзя считать зависанием только по отсутствию текста.

Правила:
- Не прерывай команды claude/loop-run/loop-step раньше бюджетов ниже.
- Heartbeat каждые 30s = значит процесс жив. Пока heartbeat идёт — продолжаем ждать.
- Если в окружении есть параметр timeout на выполнение shell-команд (например в executor/tool) — выставь:
  - для claude команд: >= 7200s
  - для loop-run: >= 9000s

Бюджеты (максимум ожидания до принудительной остановки):
- idea-new / researcher / plan-new / review-spec / tasks-new: до 60 минут каждая
- implement / review / qa: до 90 минут каждая
- loop-run: до 120 минут
- loop-step: до 45 минут на шаг

Если бюджет превышен:
- Сначала собери диагностику (ps + tail logs + инвентарь артефактов),
- затем можно остановить процесс,
- и ОБЯЗАТЕЛЬНО пометить все “финальные артефакты” как NOT VERIFIED (killed).

============================================================
HARD RULES

R0) Ticket-only first call (кроме idea-new):
- Первый запуск каждой команды (кроме idea-new) = только $TICKET.
- Повторный запуск из-за вопросов: note содержит ТОЛЬКО блок AIDD:ANSWERS.

R0.1) idea-new: slug-hint всегда отдельным аргументом:
- /feature-dev-aidd:idea-new $TICKET $SLUG_HINT <note...>
- при повторе с ответами: тот же $SLUG_HINT + исходное описание + AIDD:ANSWERS

R1) Manual implement/review only once:
- Ровно 1 ручная итерация implement -> review (seed run).
- Потом обязательно ralph loop-run/loop-step.
- Если ralph падает — BUG (blocker) и не делать дополнительных ручных итераций.

R2) No manual edits:
- Никаких ручных правок PRD/Plan/Research/Tasklist/.active.json ради фиксов.

R3) Secrets hygiene:
- Не читать/не печатать секреты (.env/keys/tokens). Если встретилось — SKIPPED/REDACTED.

============================================================
0) DETECT MODE: LEGACY vs SKILL_FIRST

AUDIT_MODE = SKILL_FIRST если:
- $PLUGIN_DIR/skills/aidd-core/SKILL.md существует
- и существует stage skill (например) $PLUGIN_DIR/skills/implement/SKILL.md

Иначе: LEGACY.

LEGACY: DocOps/readmap/writemap/actions/preflight = NOT APPLICABLE.
SKILL_FIRST: DocOps/readmap/writemap/actions/preflight = обязательны (если команда дошла до соответствующей точки и завершилась нормально).

============================================================
КАНОН (must-read)

Templates:
- $PLUGIN_DIR/templates/aidd/AGENTS.md
- $PLUGIN_DIR/templates/aidd/docs/prompting/conventions.md
- $PLUGIN_DIR/templates/aidd/docs/loops/template.loop-pack.md
- $PLUGIN_DIR/templates/aidd/docs/tasklist/template.md

Skills (если SKILL_FIRST):
- $PLUGIN_DIR/skills/aidd-core/SKILL.md
- $PLUGIN_DIR/skills/aidd-loop/SKILL.md
- (если есть) $PLUGIN_DIR/skills/aidd-reference/wrapper_contract.md
- implement/review/qa SKILL.md (если есть)

============================================================
LOGGING: НЕ СОЗДАВАЙ aidd/ ДО aidd-init

Audit logs до init пишем в:
- AUDIT_DIR=$PROJECT_DIR/.aidd_audit/$TICKET/$RUN_TS

После успешного aidd-init:
- (опционально) копируем AUDIT_DIR -> $PROJECT_DIR/aidd/reports/audit/$TICKET/$RUN_TS

============================================================
WRAPPERS (heartbeat + logs)

В bash:

export PROJECT_DIR="..."
export PLUGIN_DIR="..."
export CLAUDE_PLUGIN_ROOT="$PLUGIN_DIR"
export TICKET="..."
export SLUG_HINT="..."
export AIDD_HOOKS_MODE="${AIDD_HOOKS_MODE:-fast}"

RUN_TS="$(date -u +%Y%m%dT%H%M%SZ)"
AUDIT_DIR="$PROJECT_DIR/.aidd_audit/$TICKET/$RUN_TS"
mkdir -p "$AUDIT_DIR"

run_logged () {
  local log="$1"; shift
  {
    echo "=== CMD START $(date -u +%Y-%m-%dT%H:%M:%SZ) ==="
    echo "PWD: $(pwd)"
    echo "CMD: $*"
    echo "AIDD_HOOKS_MODE=${AIDD_HOOKS_MODE:-}"
    echo "CLAUDE_PLUGIN_ROOT=${CLAUDE_PLUGIN_ROOT:-}"
    echo "==============================="
  } >>"$log"

  ( "$@" ) >>"$log" 2>&1 &
  local pid=$!

  while kill -0 "$pid" >/dev/null 2>&1; do
    echo "[audit] still running $(date -u +%Y-%m-%dT%H:%M:%SZ) pid=$pid" | tee -a "$log"
    # показываем хвост лога, чтобы видно было прогресс, даже если “тихо”
    tail -n 10 "$log" 2>/dev/null | sed 's/^/[tail] /' | tee -a "$log" >/dev/null
    sleep 30
  done

  wait "$pid"
  local code=$?
  echo "=== CMD EXIT $(date -u +%Y-%m-%dT%H:%M:%SZ) code=$code ===" | tee -a "$log"
  return "$code"
}

run_claude () {
  local log="$1"; shift
  run_logged "$log" bash -lc "cd \"$PROJECT_DIR\" && CLAUDE_PLUGIN_ROOT=\"$PLUGIN_DIR\" AIDD_HOOKS_MODE=\"${AIDD_HOOKS_MODE:-fast}\" claude --plugin-dir \"$PLUGIN_DIR\" --add-dir \"$PLUGIN_DIR\" -p \"$*\""
}

============================================================
ШАГИ АУДИТА

0) Clean state
- cd "$PROJECT_DIR"
- git status --porcelain > "$AUDIT_DIR/00_git_status_before.txt"
- если не пусто:
  git stash push -u -m "pre-aidd-flow-audit $TICKET"
- git status --porcelain > "$AUDIT_DIR/00_git_status_after.txt"
- если stash невозможен -> BUG (blocker) и STOP.

1) Preflight
- git checkout -b audit/aidd-flow-$TICKET || git checkout audit/aidd-flow-$TICKET
- git rev-parse HEAD > "$AUDIT_DIR/01_git_head.txt"
- git rev-parse --abbrev-ref HEAD > "$AUDIT_DIR/01_git_branch.txt"

- Определи AUDIT_MODE и запиши в "$AUDIT_DIR/01_mode.txt"
- Зафиксируй must-read files (paths + head 20 lines) в "$AUDIT_DIR/01_must_read.txt"

- run_claude "$AUDIT_DIR/01_status.log" "/feature-dev-aidd:status $TICKET" || true

2) Baseline
- (важно) НЕ создавать aidd/ руками
- ls -la > "$AUDIT_DIR/02_ls_root.txt"
- [ -d aidd ] && find aidd -maxdepth 3 -type f | sort > "$AUDIT_DIR/02_aidd_tree_pre.txt" || echo "aidd: missing" > "$AUDIT_DIR/02_aidd_tree_pre.txt"

3) Problem statement
- Сформулируй задачу для TST-001 (3–6 предложений + 2–4 AC) и сохрани в "$AUDIT_DIR/03_problem_statement.txt"

4) aidd-init (если workspace не готов)
Workspace считается готовым, если существует:
- $PROJECT_DIR/aidd/AGENTS.md
- $PROJECT_DIR/aidd/docs/prompting/conventions.md

Если не готово:
- run_claude "$AUDIT_DIR/04_aidd_init.log" "/feature-dev-aidd:aidd-init"

После:
- find aidd -maxdepth 4 -type f | sort > "$AUDIT_DIR/04_aidd_tree_post.txt"
- (опционально) mkdir -p "$PROJECT_DIR/aidd/reports/audit/$TICKET/$RUN_TS" и копировать туда AUDIT_DIR в самом конце.

5) Happy path
5.1) idea-new
- run_claude "$AUDIT_DIR/05_idea_new.log" "/feature-dev-aidd:idea-new $TICKET $SLUG_HINT <описание + AC>"
Если вопросы:
- выпиши вопросы
- run_claude "$AUDIT_DIR/05_idea_new_answers.log" "/feature-dev-aidd:idea-new $TICKET $SLUG_HINT <исходное описание + AIDD:ANSWERS>"

Сними:
- cat aidd/docs/.active.json > "$AUDIT_DIR/05_active.json" || true
- sed -n '1,80p' aidd/docs/prd/$TICKET.prd.md > "$AUDIT_DIR/05_prd_head.txt" || true

5.2) researcher (ticket-only)
- run_claude "$AUDIT_DIR/05_researcher.log" "/feature-dev-aidd:researcher $TICKET"
(при вопросах — повтор с AIDD:ANSWERS)

5.3) plan-new
- run_claude "$AUDIT_DIR/05_plan_new.log" "/feature-dev-aidd:plan-new $TICKET"

5.4) review-spec
- run_claude "$AUDIT_DIR/05_review_spec.log" "/feature-dev-aidd:review-spec $TICKET"
(при вопросах — повтор с AIDD:ANSWERS)

5.5) tasks-new
- run_claude "$AUDIT_DIR/05_tasks_new.log" "/feature-dev-aidd:tasks-new $TICKET"
Проверка статуса:
- извлеки header Status из tasklist и запиши в "$AUDIT_DIR/05_tasklist_status_check.txt"
  (например grep 'Status:' первые 40 строк)
Если команда заявила READY, а tasklist остался PENDING:
- BUG major (status sync mismatch), но продолжай (это важно для проверки loop стадий).

6) Loop (seed implement/review — 1 раз)
- run_claude "$AUDIT_DIR/06_implement_seed.log" "/feature-dev-aidd:implement $TICKET"
- run_claude "$AUDIT_DIR/06_review_seed.log" "/feature-dev-aidd:review $TICKET"

ВАЖНО:
- Если эти команды были ПРИНУДИТЕЛЬНО остановлены (exit 143/137/etc):
  - фиксируй BUG “command did not terminate”
  - НЕ делай вывод “stage_result missing” как blocker‑регрессию; пометь stage_result checks как NOT VERIFIED (killed).
  - затем всё равно пробуй loop-run, чтобы зафиксировать деградацию.

Диагностика preflight (SKILL_FIRST) — делай сразу после старта implement/review, если кажется “тихо”:
- через 2–3 минуты (НЕ останавливая процесс) посмотри, появились ли:
  - aidd/reports/actions/**/<stage>.actions.template.json
  - aidd/reports/context/**.readmap.*
  - aidd/reports/context/**.writemap.*
  - stage.preflight.result.json
Если нет — это сильный сигнал, что preflight вообще не запускается (major/blocker по W93).

7) Auto-loop
- run_logged "$AUDIT_DIR/07_loop_run.log" bash -lc "cd \"$PROJECT_DIR\" && CLAUDE_PLUGIN_ROOT=\"$PLUGIN_DIR\" \"$PLUGIN_DIR/tools/loop-run.sh\" --ticket \"$TICKET\" --max-iterations 6 --stream"

8) QA
- run_claude "$AUDIT_DIR/08_qa.log" "/feature-dev-aidd:qa $TICKET"
Если QA был убит:
- BUG major “qa termination/hang”, а выводы про stage.qa.result делать осторожно.

============================================================
ФИНАЛЬНЫЙ ОТЧЁТ (в чат)

- Таблица шагов PASS/WARN/FAIL
- Отдельно: что было NOT VERIFIED из-за kill
- BUG REPORTS (severity)
- Ralph loop summary (если дошёл)
- Список команд + пути к логам в AUDIT_DIR

Последняя строка:
AUDIT_COMPLETE TST-001