# Prompt Playbook

Документ описывает единые требования к промптам агентов и слэш-команд Claude Code. Следуя этим правилам, вы получите предсказуемое поведение агентов, детерминированные гейты и повторяемые ответы на вопросы «что должен сделать агент?».

## 1. Назначение
- Зафиксировать обязательные блоки и тональность промптов.
- Синхронизировать ожидания по входам/выходам между агентами и командными файлами.
- Минимизировать дублирование инструкций (например, правила `Checkbox updated`) и держать их в одном месте.
- Задать единый словарь терминов (ticket, slug, plan, PRD, tasklist) и порядок ссылок на артефакты.

## 2. Структура промпта

### 2.1 YAML фронт-маттер
Каждый файл `.claude/agents/*.md` и `.claude/commands/*.md` начинается с блока:

```yaml
---
name: <agent-name>          # для команд поле `name` опционально, но требуется `description`
description: ...            # короткое назначение (≤120 символов)
lang: ru                    # ru или en; при добавлении EN версии поле обязательно
prompt_version: 1.0.0       # major.minor.patch
source_version: 1.0.0       # если документ локализован, укажите версию оригинала
tools: Read, Write, ...     # только разрешённые инструменты
model: inherit | opus       # при необходимости фиксируйте модель
---
```

Требования:
- Поля `lang`, `prompt_version`, `description` обязательны. `source_version` требуется для локализаций.
- `prompt_version` повышается при любых правках текста (см. раздел 7).
- Список инструментов перечисляйте через запятую; wildcard `Bash(*)` запрещён, только конкретные команды.

### 2.2 Обязательные разделы
После фронт-маттера соблюдайте блоки в указанном порядке:
1. **Контекст** — 1–3 абзаца с ролью, основными входами и ссылками на артефакты (`@docs/...`).
2. **Входные артефакты** — маркированный список (`- PRD: docs/prd/<ticket>.prd.md`). Указывайте обязательность и fallback (например, «если отчёт research отсутствует → попроси запустить команду»).
3. **Автоматизация** — что делает CLA `gate-*`, какие переменные окружения поддерживаются, как реагировать на автозапуск `format-and-test`.
4. **Пошаговый план** — пронумерованный список действий агента/команды. Для команд допускается блок «Когда запускать / Что модифицируем / Ожидаемый вывод».
5. **Fail-fast & вопросы** — что считать блокером, как задавать вопросы пользователю (формат, обязательные ответы).
6. **Формат ответа** — чёткие требования к финальному сообщению (статус, блоки, `Checkbox updated`).

Запрещено использовать свободный текст вне этих блоков: если нужна справка, добавьте ссылку на документ (`см. docs/agents-playbook.md`).

### 2.3 Локализация
- RU-файлы используются рантаймом (`.claude/agents/*.md`, `.claude/commands/*.md`), EN-хранилище — `prompts/en/agents/*.md`, `prompts/en/commands/*.md`.
- Заголовки разделов переводятся: `Контекст` → `Context`, `Входные артефакты` → `Input Artifacts`, `Fail-fast и вопросы` → `Fail-fast & Questions`, и т.д. (см. EN примеры в `prompts/en/**`).
- Добавьте `Lang-Parity: skip` в фронт-маттер только когда одну локаль намеренно пропускают (например, черновик); после синхронизации уберите.
- Версионные правила и workflow описаны в `docs/prompt-versioning.md`.

## 3. Правила `Checkbox updated`
- Всегда начинайте блок статуса строкой `Checkbox updated: <список>` или `Checkbox updated: none`.
- Формат списка: идентификатор чекбокса (`1.1 – Аналитика`) или ссылку на файл (`docs/tasklist/ABC-123.md: QA #3`).
- Команды/агенты, которые не обновляют tasklist, должны явно указывать `Checkbox updated: not-applicable`.
- Любые дополнения (например, краткий отчёт) следуют после строки `Checkbox updated: ...`.

## 4. Fail-fast и эскалация
- Если обязательный вход отсутствует → немедленно завершайте ответ со статусом `BLOCKED` и перечисляйте, какую команду запустить (`/idea-new`, `claude-workflow research ...`).
- При сомнениях по архитектуре или миграциям формируйте список вопросов в конце ответа и не продолжайте реализацию.
- Для слэш-команд описывайте, как проверять готовность (например, `!bash -lc 'claude-workflow progress ...'`).

## 5. Матрица «роль → артефакты/хуки»

| Роль/команда | Обязательные артефакты | Автохуки/гейты | Вывод | Ссылки |
| --- | --- | --- | --- | --- |
| `analyst` / `/idea-new` | `docs/prd/<ticket>.prd.md`, `docs/research/<ticket>.md` | `gate-prd-review`, `gate-workflow` | PRD READY/BLOCKED, список вопросов | `docs/prd.template.md`, `docs/agents-playbook.md` |
| `planner` / `/plan-new` | PRD (Status: approved), research, `docs/plan/<ticket>.md` | `gate-workflow` | План с DoD/метриками | `docs/plan/.template` |
| `implementer` / `/implement` | План, tasklist, reports | `gate-tests`, `gate-db-migration` | Код + обновлённый tasklist | `templates/tasklist.md` |
| `reviewer` / `/review` | Diff, план, tasklist | `gate-tests`, `gate-qa` | Замечания + tasklist | `docs/agents-playbook.md` |
| `qa` | Tasklist, логи гейтов | `gate-qa`, `.claude/hooks/gate-qa.sh` | QA отчёт | `docs/qa-playbook.md` |

Расширяйте матрицу по мере добавления агентов. Таблица используется линтером для проверки ссылок.

## 6. Автоматизация и ссылки
- Ссылайтесь на переменные окружения из `.claude/settings.json` (например, `SKIP_AUTO_TESTS`, `TEST_SCOPE`).
- Для команд, которые вызывают дополнительные скрипты, описывайте формат `!bash -lc '...'` и ожидаемые побочные эффекты.
- Если агент должен запускаться из палитры (например, `qa`), напишите явное указание «Запусти через Claude: Run agent → qa».

## 7. Процесс изменений и версионирование
- Любая правка текста или структуры требует увеличения `prompt_version` (major — изменение секций/формата, minor — содержание, patch — уточнение формулировок/примеры).
- EN-файл обязан держать `prompt_version`, равный RU, а `source_version` = текущей RU-версии; детали в `docs/prompt-versioning.md`.
- Используйте `scripts/prompt-version bump --prompts <name> --kind agent|command --lang ru,en --part <...>` и `tools/prompt_diff.py` для контроля изменений.
- После обновления промпта обязательно опишите изменения в `docs/release-notes.md` и при необходимости добавьте запись в `CHANGELOG.md`.

## 8. Минимальный чеклист перед публикацией
1. Проверить фронт-маттер (`lang`, `prompt_version`, инструменты).
2. Убедиться, что все обязательные блоки присутствуют и оформлены.
3. Добавить ссылку на соответствующую таблицу в разделе 5 (если роль новая).
4. Запустить `scripts/lint-prompts.py` и убедиться, что проверки пройдены.
5. Обновить `doc/backlog.md` и сопутствующие документы (README, docs/agents-playbook.md) при необходимости.

Следование этому плейбуку гарантирует, что агенты и команды работают консистентно в любых проектах, подключивших workflow.

## 9. Шаблоны и автоматизация
- Используйте `templates/prompt-agent.md` и `templates/prompt-command.md` как базу: они уже содержат требуемые секции и подсказки.
- Для быстрого старта запустите `python3 scripts/scaffold_prompt.py --type agent --target .claude/agents/<name>.md --name <name> --description "..."` (или `--type command`). Скрипт подставит фронт-маттер и создаст файл; `--force` перезаписывает существующий.
- В IDE можно вызвать `claude-workflow preset prompt-governance --prompt_type agent --target_path .claude/agents/<name>.md --name <name>` — пресет подтянет playbook и шаблон, чтобы Claude Code сам дополнил секции.
- Проверяйте локализации: `python3 scripts/lint-prompts.py`, `tools/prompt_diff.py --kind command --name plan-new`, `scripts/prompt-version bump --prompts plan-new --kind command --lang ru,en --part patch --dry-run`.
- После генерации обязательно вручную заполните все блоки и обновите `prompt_version`/`source_version`, если правки вносились вручную или делался перевод.
