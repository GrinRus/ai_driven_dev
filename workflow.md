# Workflow Claude Code

Документ описывает целевой процесс работы команды после запуска `init-claude-workflow.sh`. Цикл строится вокруг идеи и проходит шесть этапов: **идея → план → валидация → задачи → реализация → ревью**. На каждом шаге задействованы специализированные саб-агенты Claude Code и автоматические гейты, которые защищают кодовую базу.

## Обзор этапов

| Этап | Команда | Саб-агент | Основные артефакты |
| --- | --- | --- | --- |
| Аналитика идеи | `/idea-new <slug> [TICKET]` | `analyst` | `docs/prd/<slug>.prd.md`, активная фича |
| Планирование | `/plan-new <slug>` | `planner`, `validator` | `docs/plan/<slug>.md`, уточнённые вопросы |
| Тасклист | `/tasks-new <slug>` | — | `tasklist.md` (обновлённые чеклисты) |
| Реализация | `/implement <slug>` | `implementer` | кодовые изменения, обновлённые тесты |
| Доп. артефакты | `/api-spec-new <slug>`, `/tests-generate <slug>` | `api-designer`, `qa-author` | `docs/api/<slug>.yaml`, `docs/test/<slug>-manual.md` |
| Ревью | `/review <slug>` | `reviewer` | замечания в `tasklist.md`, итоговый статус |

## Подробности по шагам

### 1. Идея (`/idea-new`)
- Устанавливает активную фичу (`docs/.active_feature`).
- Создаёт PRD по шаблону (`docs/prd/<slug>.prd.md`), собирает вводные, риски и метрики.
- Саб-агент **analyst** уточняет контекст и формирует финальный документ.

### 2. План (`/plan-new`)
- Саб-агент **planner** формирует пошаговый план реализации по PRD.
- Саб-агент **validator** проверяет план; найденные вопросы возвращаются продукту.
- Все открытые вопросы синхронизируются между PRD и планом.

### 3. Тасклист (`/tasks-new`)
- Преобразует план в чеклисты в `tasklist.md`.
- Структурирует задачи по этапам (аналитика, разработка, QA, релиз).
- Добавляет критерии приёмки и зависимости.

### 4. Реализация (`/implement`)
- Саб-агент **implementer** следует шагам плана и вносит изменения малыми итерациями.
- После каждой правки автоматически запускается `/test-changed` (отключаемо через `SKIP_AUTO_TESTS=1`).
- Изменения блокируются до появления необходимых артефактов гейтами:
  - `gate-workflow.sh` — проверяет наличие PRD/плана/тасклиста.
  - `gate-api-contract.sh` — требует OpenAPI контракт для активной фичи.
  - `gate-db-migration.sh` — проверяет наличие миграций при изменении сущностей.
  - `gate-tests.sh` — убеждается, что для исходников есть тесты (soft/hard режим).

### 5. Дополнительные артефакты
- `/api-spec-new <slug>` задействует **api-designer** для генерации или обновления OpenAPI.
- `/tests-generate <slug>` подключает **qa-author**, который дополняет автотесты и формирует чеклист ручного тестирования (`docs/test/<slug>-manual.md`).
- Эти команды помогают пройти API/DB/тест-гейты и ускоряют ревью.

### 6. Ревью (`/review`)
- Саб-агент **reviewer** проводит код-ревью и синхронизирует замечания в `tasklist.md`.
- При блокирующих проблемах фича возвращается на стадию реализации; при минорных — фиксируется список рекомендаций.

## Автоматизация и гейты

- `.claude/settings.json` включает пресет `strict`, который запускает защитные хуки при любой записи (`Write|Edit`).
- `.claude/hooks/format-and-test.sh` выполняет форматирование и выборочные Gradle-тесты; полный прогон запускается, если изменены общие файлы.
- Переменная `SKIP_AUTO_TESTS=1` временно отключает автостарт `/test-changed` (полезно для больших миграций или отладки).
- `config/gates.json` управляет режимами гейтов:
  - `api_contract`, `db_migration` — включение/отключение проверок.
  - `tests_required` — `disabled`/`soft`/`hard`.
  - `feature_slug_source` — путь к файлу с активной фичей.
- При необходимости можно расширить список гейтов (см. `docs/customization.md`).

## Роли и ответственность команды

- **Product/Analyst** — поддерживает PRD и контролирует, что вопросы валидируются.
- **Tech Lead/Architect** — утверждает план и следит за API/DB гейтами.
- **Разработчики** — реализуют по плану и поддерживают актуальность тестов и документации.
- **QA** — участвует в `/tests-generate`, наполняет `docs/test/*.md` и помогает с гейтами `gate-tests.sh`.
- **Reviewer** — финализирует фичу, проверяет, что все чеклисты в `tasklist.md` закрыты.

Следуйте этому циклу, чтобы команда оставалась синхронизированной, а артефакты — в актуальном состоянии.
