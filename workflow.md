# Workflow Claude Code

Документ описывает целевой процесс работы команды после запуска `init-claude-workflow.sh`. Цикл строится вокруг идеи и проходит пять этапов: **идея → план → задачи → реализация → ревью**. На каждом шаге задействованы специализированные саб-агенты Claude Code и защитные хуки, которые помогают удерживать кодовую базу в рабочем состоянии.

## Обзор этапов

| Этап | Команда | Саб-агент | Основные артефакты |
| --- | --- | --- | --- |
| Аналитика идеи | `/idea-new <slug> [TICKET]` | `analyst` | `docs/prd/<slug>.prd.md`, активная фича |
| Планирование | `/plan-new <slug>` | `planner`, `validator` | `docs/plan/<slug>.md`, уточнённые вопросы |
| Тасклист | `/tasks-new <slug>` | — | `tasklist.md` (обновлённые чеклисты) |
| Реализация | `/implement <slug>` | `implementer` | кодовые изменения, актуальные тесты |
| Ревью | `/review <slug>` | `reviewer` | замечания в `tasklist.md`, итоговый статус |

## Подробности по шагам

### 1. Идея (`/idea-new`)
- Устанавливает активную фичу (`docs/.active_feature`).
- Создаёт PRD по шаблону (`docs/prd/<slug>.prd.md`), собирает вводные, риски и метрики.
- Саб-агент **analyst** уточняет контекст и фиксирует открытые вопросы.

### 2. План (`/plan-new`)
- Саб-агент **planner** формирует пошаговый план реализации по PRD.
- Саб-агент **validator** проверяет полноту; найденные вопросы возвращаются продукту.
- Все открытые вопросы синхронизируются между PRD и планом.

### 3. Тасклист (`/tasks-new`)
- Преобразует план в чеклисты в `tasklist.md`.
- Структурирует задачи по этапам (аналитика, разработка, QA, релиз).
- Добавляет критерии приёмки и зависимости.

### 4. Реализация (`/implement`)
- Саб-агент **implementer** следует шагам плана и вносит изменения малыми итерациями.
- После каждой правки автоматически запускается `.claude/hooks/format-and-test.sh` (отключаемо через `SKIP_AUTO_TESTS=1`).
- Если включены дополнительные гейты (`config/gates.json`), следите за сообщениями `gate-db-migration.sh`, `gate-tests.sh` или `gate-api-contract.sh`.

### 5. Ревью (`/review`)
- Саб-агент **reviewer** проводит код-ревью и синхронизирует замечания в `tasklist.md`.
- При блокирующих проблемах фича возвращается на стадию реализации; при минорных — формируется список рекомендаций.

## Автоматизация и гейты

- Пресет `strict` в `.claude/settings.json` включает `protect-prod`, `gate-workflow` и автозапуск `.claude/hooks/format-and-test.sh` после каждой записи.
- `config/gates.json` управляет дополнительными проверками:
  - `api_contract` — при `true` ожидает наличие `docs/api/<slug>.yaml` для контроллеров.
  - `db_migration` — при `true` требует новую миграцию в `src/main/resources/**/db/migration/`.
  - `tests_required` — режим `disabled|soft|hard` для проверки юнит-тестов.
  - `feature_slug_source` — путь к файлу с активной фичей (по умолчанию `docs/.active_feature`).
- `SKIP_AUTO_TESTS=1` временно отключает форматирование и выборочные тесты.
- `STRICT_TESTS=1` заставляет `.claude/hooks/format-and-test.sh` завершаться ошибкой при падении тестов.

## Роли и ответственность команды

- **Product/Analyst** — поддерживает PRD, отвечает на вопросы planner/validator.
- **Tech Lead/Architect** — утверждает план, следит за гейтами и архитектурными решениями.
- **Разработчики** — реализуют по плану, поддерживают тесты и документацию в актуальном состоянии.
- **QA** — помогает с чеклистами в `tasklist.md`, расширяет тестовое покрытие и сценарии ручной проверки.
- **Reviewer** — финализирует фичу, проверяет, что все чеклисты в `tasklist.md` закрыты.

Следуйте этому циклу, чтобы команда оставалась синхронизированной, а артефакты — актуальными.
