---
name: CI

'on':
  push:
    branches: [main]
  pull_request:

env:
  AIDD_SECURITY_ENFORCE: ${{ vars.AIDD_SECURITY_ENFORCE || '0' }}

jobs:
  lint-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch base branch
        if: ${{ github.event_name == 'pull_request' }}
        run: |
          git fetch origin "${GITHUB_BASE_REF}:${GITHUB_BASE_REF}"

      - name: Install linters
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck yamllint ripgrep
          npm install -g markdownlint-cli

      - name: Run ci-lint script
        run: tests/repo_tools/ci-lint.sh

      - name: Bootstrap AIDD workspace for QA gate
        run: |
          QA_WORKSPACE="$(mktemp -d)"
          echo "QA_WORKSPACE=${QA_WORKSPACE}" >> "${GITHUB_ENV}"
          cd "${QA_WORKSPACE}"
          CLAUDE_PLUGIN_ROOT="${GITHUB_WORKSPACE}" \
            PYTHONPATH="${GITHUB_WORKSPACE}" \
            python3 "${GITHUB_WORKSPACE}/skills/aidd-init/runtime/init.py"

      - name: Run QA gate
        run: |
          cd "${QA_WORKSPACE}"
          if [[ -n "${GITHUB_BASE_REF}" ]]; then
            export QA_AGENT_DIFF_BASE="${GITHUB_BASE_REF}"
          else
            unset QA_AGENT_DIFF_BASE
          fi
          export CLAUDE_PLUGIN_ROOT="${GITHUB_WORKSPACE}"
          "${GITHUB_WORKSPACE}/hooks/gate-qa.sh" --payload '{}'

  smoke-workflow:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect runtime changes
        id: runtime_changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            runtime:
              - 'skills/**'
              - 'hooks/**'
              - 'tools/**'
              - 'agents/**'
              - 'templates/aidd/**'
              - '.claude-plugin/**'

      - name: Run smoke workflow
        if: steps.runtime_changes.outputs.runtime == 'true'
        run: tests/repo_tools/smoke-workflow.sh

      - name: Skip smoke workflow (no runtime changes)
        if: steps.runtime_changes.outputs.runtime != 'true'
        run: echo "No runtime changes; skipping smoke"

  dependency-review:
    if: ${{ github.event_name == 'pull_request' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Dependency review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: high

  security-secret-scan:
    name: security-secret-scan
    runs-on: ubuntu-latest
    continue-on-error: ${{ env.AIDD_SECURITY_ENFORCE != '1' }}
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run gitleaks secret scan
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Security rollout notice
        if: ${{ env.AIDD_SECURITY_ENFORCE != '1' }}
        run: |
          echo "security-secret-scan is advisory"
          echo "set AIDD_SECURITY_ENFORCE=1 to make it required"

  security-sast:
    name: security-sast
    runs-on: ubuntu-latest
    continue-on-error: ${{ env.AIDD_SECURITY_ENFORCE != '1' }}
    permissions:
      actions: read
      contents: read
      security-events: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: python

      - name: Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: Analyze
        uses: github/codeql-action/analyze@v3

      - name: Security rollout notice
        if: ${{ env.AIDD_SECURITY_ENFORCE != '1' }}
        run: |
          echo "security-sast is advisory"
          echo "set AIDD_SECURITY_ENFORCE=1 to make it required"
