# Playbook агентов и барьеров Claude Code

Документ помогает быстро запустить фичу в Claude Code: кто из саб-агентов за что отвечает, какие команды их активируют, какие артефакты ожидаются на выходе и какие барьеры (gate-скрипты) могут остановить работу. Следуйте последовательности, чтобы избежать блокировок и лишних циклов уточнений.

## Содержание
- [Ролевая цепочка](#ролевая-цепочка)
- [Агенты и ожидаемые результаты](#агенты-и-ожидаемые-результаты)
- [Работа с барьерами](#работа-с-барьерами)
- [Чеклист быстрого старта фичи](#чеклист-быстрого-старта-фичи)

## Ролевая цепочка

| Шаг | Команда | Агент(ы) | Основной вход | Основной выход | Когда считается готовым |
| --- | --- | --- | --- | --- | --- |
| 0 | `/feature-activate <slug>` (опционально) | — | Название фичи/тикета | `docs/.active_feature` | slug выставлен и совпадает с веткой |
| 1 | `/idea-new <slug> [TICKET]` | `analyst` | Свободная идея, вводные | `docs/prd/<slug>.prd.md`, статус READY/BLOCKED | PRD заполнен, открытые вопросы выписаны |
| 2 | `/plan-new <slug>` | `planner`, `validator` | PRD и ответы на вопросы | `docs/plan/<slug>.md` + протокол валидации | План покрывает все этапы, критичные вопросы закрыты |
| 3 | `/tasks-new <slug>` | — | Утверждённый план | Обновлённый `tasklist.md` | Чеклисты выстроены по этапам и привязаны к slug |
| 4 | `/api-spec-new <slug>` | `api-designer` | PRD и запросы на интеграцию | `docs/api/<slug>.yaml` | Контракт согласован, перечислены неопределённости |
| 5 | `Claude: Run agent → contract-checker` (при необходимости) | `contract-checker` | Код контроллеров и API контракт | Отчёт с расхождениями/OK | Несоответствия устранены или занесены в задачи |
| 6 | `Claude: Run agent → db-migrator` (при изменении схемы) | `db-migrator` | Модель данных, план | Новый файл в `**/db/migration/` | Миграция создана, план дополнен ручными шагами |
| 7 | `/tests-generate <slug>` | `qa-author` | План, реализованный код | Юнит/интеграционные тесты, `docs/test/<slug>-manual.md` | Тесты добавлены, сценарии ручного теста готовы |
| 8 | `/implement <slug>` | `implementer` | План, чеклисты, контракты | Кодовые изменения + авто `/test-changed` | Коммиты проходят гейты и тесты |
| 9 | `/review <slug>` | `reviewer` | Готовая ветка, артефакты | Заключение и список замечаний | Все блокеры сняты, чеклисты закрыты |

> `contract-checker` и `db-migrator` не имеют отдельных слэш-команд. Вызывайте их из палитры `Claude: Run agent …` в IDE; при необходимости добавьте отдельный пресет для быстрого запуска или задействуйте CLI-скрипт.

## Агенты и ожидаемые результаты

### analyst — аналитика идеи
- **Вызов:** `/idea-new <slug> [TICKET]`
- **Вход:** свободное описание задачи, бизнес-контекст, ограничения.
- **Выход:** PRD `docs/prd/<slug>.prd.md` с секциями целей, пользовательских историй, метрик успеха, рисков и открытых вопросов.
- **Критерии готовности:** PRD имеет статус READY или содержит явный список блокирующих вопросов; активная фича в `docs/.active_feature` совпадает со slug.

### planner — план реализации
- **Вызов:** `/plan-new <slug>`
- **Вход:** актуальный PRD и ответы на вопросы аналитика.
- **Выход:** `docs/plan/<slug>.md` с декомпозицией на итерации, DoD и ссылками на модули/файлы.
- **Особенности:** после генерации план сразу проходит ревью агентом `validator`; открытые вопросы синхронизируются обратно в PRD.

### validator — проверка плана
- **Вызов:** автоматически внутри `/plan-new`.
- **Вход:** PRD и свежий план.
- **Выход:** блок в конце плана с итогом PASS/FAIL и списком вопросов для пользователя.
- **Советы:** отвечайте на вопросы и перезапускайте `/plan-new`, пока статус не станет PASS.

### implementer — реализация
- **Вызов:** `/implement <slug>`
- **Вход:** утверждённый план, tasklist, артефакты API/БД/тестов.
- **Выход:** пул маленьких коммитов с автоматическим запуском `/test-changed` после каждой правки.
- **Важно:** следите за уведомлениями гейтов в консоли Claude. При блокировке устраните причину и повторите шаг.

### reviewer — финальное ревью
- **Вызов:** `/review <slug>`
- **Вход:** готовая ветка с пройденными гейтами, результаты тестов.
- **Выход:** список замечаний (BLOCKED или SUGGESTIONS) и резюме статуса фичи.
- **Советы:** перед вызовом убедитесь, что `tasklist.md` закрыт и PRD/план обновлены последними изменениями.

### api-designer — контракт API
- **Вызов:** `/api-spec-new <slug>`
- **Вход:** PRD, открытые вопросы по интеграциям, текущий `docs/api/<slug>.yaml` (если есть).
- **Выход:** валидный OpenAPI 3.0+ файл с описанием ручек, схемами, ошибками и примерами.
- **Варианты:** если контракт хранится в другом месте, обновите `config/gates.json` и сохраните артефакт рядом, чтобы пройти `gate-api-contract`.

### contract-checker — сверка кода и контракта
- **Вызов:** `Claude: Run agent → contract-checker <slug>`
- **Вход:** OpenAPI файл и исходники контроллеров/роутов.
- **Выход:** отчёт (READY/BLOCKED) с конкретными расхождениями: отсутствующие эндпоинты, статусы, поля моделей.
- **Когда запускать:** после обновления API контракта или перед ревью, чтобы убедиться, что `gate-api-contract` не выдаст блокировку.

### db-migrator — миграции базы данных
- **Вызов:** `Claude: Run agent → db-migrator <slug>`
- **Вход:** изменения доменных моделей, описание схемы в PRD/плане.
- **Выход:** новая миграция в `src/main/resources/**/db/migration/` и пометки о ручных шагах в `docs/plan/<slug>.md` или `tasklist.md`.
- **Советы:** соблюдайте именование (например, `V20250220__checkout_discounts.sql`) и убедитесь, что миграция идемпотентна.

### qa-author — тесты и сценарии
- **Вызов:** `/tests-generate <slug>`
- **Вход:** реализованный код, актуальный план, требования к тестированию.
- **Выход:** новые/обновлённые юнит- и интеграционные тесты, сценарии ручного теста `docs/test/<slug>-manual.md`, отчёт о запуске `/test-changed`.
- **Советы:** используйте агента перед ревью и всякий раз, когда `gate-tests` жалуется на отсутствие тестов.

## Работа с барьерами

### `gate-workflow.sh`
- **Когда срабатывает:** при попытке изменить `src/**`, если активирована фича (`docs/.active_feature`) и отсутствуют ключевые артефакты.
- **Что проверяет:** наличие `docs/prd/<slug>.prd.md`, `docs/plan/<slug>.md` и актуального чеклиста в `tasklist.md`.
- **Как устранить блок:** пройдите `/idea-new`, `/plan-new`, `/tasks-new` и убедитесь, что tasklist содержит задачи по slug (без шаблонного `<slug>`).
- **Bypass:** временно отключать не рекомендуется. Вместо этого заполните отсутствующий артефакт.

### `gate-api-contract.sh`
- **Когда срабатывает:** при правках контроллеров/роутов (`src/main/**/controller|rest`) и включённом флаге `api_contract` в `config/gates.json`.
- **Что проверяет:** наличие OpenAPI файла (`docs/api/<slug>.yaml|yml|json` либо глобальный `openapi.yaml`).
- **Чем помочь:** вызовите `/api-spec-new <slug>` или руками обновите файл. После синхронизации перечитайте результат `contract-checker`.
- **Bypass:** временно выставьте `api_contract=false` в `config/gates.json` (не забудьте вернуть значение и зафиксировать причину в PR).

### `gate-db-migration.sh`
- **Когда срабатывает:** при изменении сущностей (`entity`, `model`, `repository`) или схемы в `src/main/resources/**/db`.
- **Что проверяет:** наличие новой миграции (tracked или untracked) в `src/main/resources/**/db/migration/`.
- **Чем помочь:** запустите агента `db-migrator` или вручную создайте миграцию с корректным именем и путём.
- **Bypass:** можно временно выставить `db_migration=false` в `config/gates.json`, но обязательно зафиксируйте технический долг в `tasklist.md`.

### `gate-tests.sh`
- **Когда срабатывает:** при правке файлов `src/main/**/*.kt|java`, если `tests_required` в `config/gates.json` — `soft` или `hard`.
- **Что проверяет:** существует ли тестовый файл (`src/test/**`) с суффиксом `Test`/`Tests` для изменённого класса.
- **Чем помочь:** вызовите `/tests-generate <slug>` или создайте тест вручную. В режиме `soft` появится предупреждение, в `hard` — блокировка.
- **Bypass:** установите `tests_required=soft` или `disabled`, но пропишите причину в PR и верните значение после закрытия долга.

### `.claude/hooks/lint-deps.sh`
- **Когда срабатывает:** при изменении `build.gradle*` или `gradle/libs.versions.toml`, если `deps_allowlist=true` в `config/gates.json`.
- **Что делает:** выводит `WARN`, если новая зависимость отсутствует в `config/allowed-deps.txt`.
- **Как реагировать:** добавьте зависимость в allowlist (согласовав с техлидом) или замените её разрешённой альтернативой.
- **Bypass:** отключите `deps_allowlist` в `config/gates.json` для прототипов и документируйте решение в PR.

## Чеклист быстрого старта фичи

1. `/branch-new` или вручную создайте ветку под slug (например, `feature/STORE-123`).
2. `/feature-activate <slug>` — убедитесь, что `docs/.active_feature` обновился.
3. `/idea-new <slug> [TICKET]` → получите PRD и ответьте на вопросы аналитика.
4. `/plan-new <slug>` → закройте вопросы валидатора до статуса PASS.
5. `/tasks-new <slug>` → проверьте, что чеклисты отражают план.
6. `/api-spec-new <slug>` и `contract-checker` — согласуйте контракт с кодом.
7. `db-migrator` (если затрагиваются данные) и `/tests-generate <slug>` — подготовьте миграции и тесты заранее.
8. `/implement <slug>` → двигайтесь малыми итерациями, следите за гейтами.
9. `/review <slug>` → запросите финальное ревью после прохождения всех барьеров.

Следуя этой последовательности, вы минимизируете блокировки от гейтов и ускорите путь от идеи до смёрженной фичи.
