# Feature Presets for Claude Code Workflow

## Введение

Эта спецификация фиксирует подход к пресетам Claude Code, которые автоматизируют работу с фичами. Пресеты связывают артефакты (PRD, план, тасклист, реализация, релиз) с командой `/idea-new → /review` и обеспечивают повторяемый контекст для агентов.

## Цели

- Предоставить единый формат YAML-пресетов, описывающих этап фичи, входные данные и ожидаемые артефакты.
- Обеспечить бесшовную интеграцию пресетов с существующим workflow (`workflow.md`) и CLI (`init-claude-workflow.sh`).
- Упростить запуск сценариев из демо и smoke-тестов без ручной подготовки контекста.

## Не цели

- Замена существующих слэш-команд. Пресеты дополняют команды инструкциями и контекстом.
- Автоматическая генерация содержимого PRD/ADR/тасклиста — решение принимает агент на основе пресета.
- Поддержка кастомных моделей или внешних API (вне стандартной интеграции Claude Code).

## Архитектура

### Структура каталогов

```
claude-presets/
  feature-prd.yaml
  feature-plan.yaml
  feature-impl.yaml
  advanced/
    feature-design.yaml
    feature-release.yaml
```

Каждый файл описывает конкретный шаг workflow и содержит поля:

| Поле            | Назначение                                                           |
| --------------- | -------------------------------------------------------------------- |
| `name`          | Уникальный идентификатор пресета                                     |
| `workflow_step` | Номер/название этапа (`1-idea`, `2-plan`, `3-tasklist`, `4-impl`, `5-release`) |
| `context`       | Список файлов и инструкций, которые добавляются в prompt             |
| `output`        | Метаинформация об артефактах (формат, путь назначения)               |
| `claude`        | Настройки агента (стратегия общения, температура, ограничения)       |

### Контекст пресета

Секция `context` агрегирует файлы, которые агент должен учитывать:

```yaml
context:
  files:
    - doc/backlog.md
    - workflow.md
    - docs/customization.md
  instructions:
    - "Используй активную фичу {{feature}} и сформируй PRD."
    - "Отрази критерии успеха и связанные ADR."
```

Слоты `{{feature}}`, `{{acceptance_criteria}}`, `{{plan_links}}` заполняются CLI-утилитой, которая читает `doc/backlog.md`, актуальный тасклист и дополнительные аргументы пользователя.

### Выходные данные

`output` описывает ожидаемый файл и формат:

```yaml
output:
  path: docs/prd/{{feature}}.prd.md
  format: markdown
  mode: overwrite
```

Режимы:
- `append` — добавить секцию в существующий файл (подходит для тасклистов).
- `overwrite` — полностью пересоздать файл (PRD, план).
- `update` — точечные изменения (пока не требуется).

### Настройки Claude

```yaml
claude:
  mode: interact
  temperature: 0.2
  guardrails:
    - "Сначала уточни недостающие входные данные, затем переходи к генерации."
```

Настройки должны оставаться консервативными, чтобы соблюдать гейты и чеклисты.

## Интеграция

### init-claude-workflow.sh

- Добавить копирование каталога `claude-presets/` в целевой проект.
- Поддержать флаг `--preset <name> [--feature <slug>]` для генерации артефактов по шаблону.
- Расширить вывод инструкциями по запуску пресетов.

### Slash-команды

Обновить `.claude/commands/*.md`:
- `/idea-new` → указать, что пресет `feature-prd` формирует PRD.
- `/plan-new` → добавить шаг вызова `feature-plan`.
- `/tasks-new`, `/implement`, `/review` → ссылаться на соответствующие пресеты и ожидаемые файлы.

### Smoke- и демо-сценарии

- `scripts/smoke-workflow.sh` запускает цепочку пресетов на демо-фиче и проверяет, что файлы созданы.
- `workflow.md` содержит walkthrough с указанием команды `init-claude-workflow.sh --preset feature-prd --feature checkout`.

## Источники данных

- `doc/backlog.md` — база идей и активных фич.
- `workflow.md` — структура этапов; пресеты должны ссылаться на соответствующие гейты.
- `docs/tasklist.template.md`, `docs/prd.template.md`, `docs/adr.template.md` — шаблоны, которые агент использует при генерации.

## Риски и открытые вопросы

- **Конфликты при перезаписи артефактов.** Нужно следить за режимом `mode` и предупреждать пользователей перед `overwrite`.
- **Сложность CLI-флага.** Возможен избыток аргументов; потребуется справка в README.
- **Мультифичи.** Для параллельных фич понадобится расширение CLI (например, аргумент `--output-dir`).

## План дальнейших шагов

1. Реализовать пресеты и CLI-подстановку плейсхолдеров.
2. Обновить документацию и слэш-команды.
3. Добавить smoke-тест на полный проход.
4. Собрать обратную связь от команды и уточнить стандарты для новых пресетов.
